function [ R ] = dquat2rotMatrix( dq )
    N = size(dq,1);       
    if (size(dq,2) == 8)
        R = zeros(3,3,N);
        R(1,1,:) = 1.0 - 2.0*dq(:,3).*dq(:,3) - 2.0*dq(:,4).*dq(:,4);% 1 - 2*qy2 - 2*qz2
        R(1,2,:) = 2.0*dq(:,2).*dq(:,3) - 2.0*dq(:,4).*dq(:,1);% 2*qx*qy - 2*qz*qw
        R(1,3,:) = 2.0*dq(:,2).*dq(:,4) + 2.0*dq(:,3).*dq(:,1);% 2*qx*qz + 2*qy*qw
        R(2,1,:) = 2.0*dq(:,2).*dq(:,3) + 2.0*dq(:,4).*dq(:,1);% 2*qx*qy + 2*qz*qw
        R(2,2,:) = 1.0 - 2.0*dq(:,2).*dq(:,2) - 2.0*dq(:,4).*dq(:,4);% 1 - 2*qx2 - 2*qz2
        R(2,3,:) = 2.0*dq(:,3).*dq(:,4) - 2.0*dq(:,2).*dq(:,1);% 2*qy*qz - 2*qx*qw
        R(3,1,:) = 2.0*dq(:,2).*dq(:,4) - 2.0*dq(:,3).*dq(:,1);% 2*qx*qz - 2*qy*qw
        R(3,2,:) = 2.0*dq(:,3).*dq(:,4) + 2.0*dq(:,2).*dq(:,1);% 2*qy*qz + 2*qx*qw
        R(3,3,:) = 1.0 - 2.0*dq(:,2).*dq(:,2) - 2.0*dq(:,3).*dq(:,3);% 1 - 2*qx2 - 2*qy2
    elseif (size(dq,2) == 4)
        R = zeros(2,2,N);
        R(1,1,:) = 1.0 - 2.0*dq(:,2).*dq(:,2);% 1 - 2*qy2 - 2*qz2
        R(1,2,:) = - 2.0*dq(:,2).*dq(:,1);% 2*qx*qy - 2*qz*qw
        R(2,1,:) = -R(1,2,:);% 2*qx*qy + 2*qz*qw
        R(2,2,:) = R(1,1,:);% 1 - 2*qx2 - 2*qz2
    end
end

